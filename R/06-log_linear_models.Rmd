---
title: "Log-linear models of AMR and treatment for spillover of AMR in MORDOR at 24 months"
# author: "Ariktha Srivathsan"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    code_folding: hide
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 16px;
  }
td {  /* Table  */
  font-size: 14px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 24px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 18px;
  color: Black;
}
h3 { /* Header 3 */
    font-size: 16px;
  color: Black;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>
```

```{r setup}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = TRUE) 

rm(list = ls())       

library(here)
library(broom)
library(patchwork)
library(knitr)
library(kableExtra)
```

```{r Load data}

source(here("scripts", "24-months", "00-config.R"))
source(here("scripts", "24-months", "00-functions.R"))

# Load AMR data
amr_dat_raw <- readRDS(here("data", "final", "24-months", "amr_dat.RDS"))

# Load treatment data
morb_tx_raw <- readRDS(here("data", "final", "24-months", "morb_tx_int.RDS"))
morb_rings_raw <- readRDS(here("data", "final", "24-months", "morb_rings.RDS"))

# Load population and distance to nearest CSI estimates
hrsl_rings_raw <- readRDS(here("data", "temp", "24-months", "hrsl-rings.RDS"))
csi_dist_raw <- readRDS(here("data", "temp", "24-months", "morb_csi.RDS"))

```

```{r param}
ring_div_fct <- 5000
```

```{r Prep data}

# Filtering AMR data for MLS antibiotics
amr_dat <- amr_dat_raw %>%
  dplyr::filter(ab_class == "MLS") %>%
  dplyr::select(grappe, phase, avg_res)

# Getting the under 5 population estimate within 10 km radius of each morbidity trial grappe
hrsl_rings <- hrsl_rings_raw %>%
  rename(u5_pop = total_u5_pop) %>%
  dplyr::filter(outer_radius == 10) %>%
  dplyr::select(grappe, u5_pop) %>%
  mutate(u5_pop_scale = u5_pop / 1000)

# Getting the distance to nearest CSI estimates
csi_dist <- csi_dist_raw %>%
  dplyr::select(grappe, dist_csi) %>%
  st_drop_geometry()

# Merging treatment intensity data with population and AMR data
morb_tx <- morb_tx_raw %>%
  dplyr::filter(idw_power == 1) %>%
  dplyr::select(grappe, arm, tx_type, tx_int) %>%
  pivot_wider(
    names_from = tx_type,
    values_from = tx_int
  ) %>%
  rename(
    azithro_int = azithro,
    placebo_int = placebo
  ) %>%
  left_join(amr_dat, by = "grappe") %>%
  left_join(hrsl_rings, by = "grappe") %>%
  left_join(csi_dist, by = "grappe")

  
```

# Descriptives of rings

```{r descriptives data prep}

morb_desc <- morb_rings_raw %>% 
  st_drop_geometry() %>%
  dplyr::filter(outer_radius <= 30) %>%
  dplyr::select(grappe, arm, n_children, ring_range_text, ends_with("_doses")) %>%
  mutate(
    ring_range_text = factor(ring_range_text, levels = c("0 - 10 km", "10 - 20 km", "20 - 30 km")),
    azithro_doses = azithro_doses / 1000,
    placebo_doses = placebo_doses / 1000,
    total_doses = total_doses / 1000,
    proportion_az = azithro_doses / (total_doses),
  )

morb_long <- morb_desc %>%
  dplyr::select(grappe, arm, ring_range_text, azithro_doses, placebo_doses, total_doses) %>%
  pivot_longer(
    cols = ends_with("_doses"),
    names_to = "dose_type",
    values_to = "doses",
    names_pattern = "(.+)_doses"
  ) 

```

## Number of azithromycin and placebo doses in each ring

```{r ring dose descriptives, fig.width=7.5}

morb_long %>%
  group_by(ring_range_text, dose_type) %>%
  summarise(
    min = min(doses, na.rm = TRUE),
    median = median(doses, na.rm = TRUE),
    mean = mean(doses, na.rm = TRUE),
    max = max(doses, na.rm = TRUE),
    iqr = IQR(doses, na.rm = TRUE),
    sd = sd(doses, na.rm = TRUE)
  ) %>%
  mutate(across(where(is.numeric), \(x) round(x, 2))) %>%
  knitr::kable()

ggplot(morb_long, aes(y = doses, color = arm)) +
  geom_boxplot() +
  geom_rug(alpha = 0.6) +
  facet_grid(dose_type ~ ring_range_text) +
  scale_color_manual(values = arms_colors, breaks = c("azithro", "placebo")) +
  scale_y_continuous(limits = c(0, 50)) +
  labs(y = "Doses in the ring (in thousands)", x = "Ring range") +
  theme_minimal(base_size = 14) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "bottom")

```

Looking at whether - villages with more azithro doses in the ring also have more placebo doses (dense settlement pattern) vs - villages with fewer azithro doses in the ring having more placebo doses (driven by few large settlements that happen to be randomized to an arm)

```{r doses in the ring by grappe, fig.width=9, fig.height=6}

ggplot(morb_long, aes(x = ring_range_text, y = doses, color = arm, group = grappe)) +
  geom_point() +
  geom_line(alpha = 0.6) +
  scale_color_manual(values = arms_colors, breaks = c("azithro", "placebo")) +
  scale_y_continuous(limits = c(0, 50)) +
  labs(y = "Doses in the ring (in thousands)") +
  theme_minimal(base_size = 14) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  facet_wrap(~ dose_type)

morb_long$dose_type <- factor(morb_long$dose_type, levels = c("total", "azithro", "placebo"))

ggplot(morb_long, aes(x = dose_type, y = doses, color = arm, group = grappe)) +
  geom_point() +
  geom_line(alpha = 0.6) +
  scale_color_manual(values = arms_colors, breaks = c("azithro", "placebo")) +
  scale_y_continuous(limits = c(0, 50)) +
  labs(y = "Doses in the ring (in thousands)",
       x = "Dose type") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom") +
  facet_wrap(~ ring_range_text)
```

## Azithromycin doses in each ring vs total number of doses

```{r ring dose descriptives total}

ggplot(morb_desc, aes(x = azithro_doses, y = total_doses, color = arm)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_smooth(method = "lm", se = FALSE) +
  ggpubr::stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), 
                   label.x.npc = "left", label.y.npc = "top") +
  scale_color_manual(values = arms_colors, breaks = c("azithro", "placebo")) +
  scale_x_continuous(limits = c(0, 30)) +
  scale_y_continuous(limits = c(0, 50)) +
  facet_wrap(~ ring_range_text) +
  labs(y = "Total doses in the ring (in thousands)", 
       x = "Azithro doses in the ring (in thousands)") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom")

```

## Azithromycin doses in each ring vs total number of doses in the 0 - 10 km ring

The doses in ring only includes doses in the main trial villages, not the morbidity village itself. So the total doses in the 0 - 10 km ring is independent of the number of children in the morbidity village itself (Other than being in a more densely populated area might mean higher number of children in the morbidity village).

The grey dashed line has a slope of 4 (4 rounds of treatment)

```{r ring dose descriptives total upto 10 km}

total_dose_tib <- morb_desc %>%
  dplyr::filter(ring_range_text == "0 - 10 km") %>%
  dplyr::select(grappe, total_doses) %>%
  rename(inner_total_doses = total_doses)

morb_desc <- morb_desc %>%
  left_join(total_dose_tib, by = "grappe")

ggplot(morb_desc %>% dplyr::select(arm, n_children, inner_total_doses) %>% distinct(), 
       aes(x = n_children/1000, y = inner_total_doses, color = arm)) +
  geom_point() +
  geom_abline(slope = 4, intercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_smooth(method = "lm", se = FALSE) +
  ggpubr::stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), 
                   label.x.npc = "left", label.y.npc = "top") +
  scale_color_manual(values = arms_colors, breaks = c("azithro", "placebo")) +
  # scale_x_continuous(limits = c(0, 30)) +
  scale_y_continuous(limits = c(0, 30)) +
  labs(y = "Total doses in the ring (in thousands)",
       x = "Number of children in the monitoring village (in thousands)") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom")

```

Checking for collinearity between azithromycin doses in a ring and total doses in the 0 - 10 km ring.

```{r azithro doses in ring vs total doses in 0 - 10 km ring}

ggplot(morb_desc, aes(x = azithro_doses, y = inner_total_doses, color = arm)) +
  geom_point() +
  geom_rug(sides = "bl") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_smooth(method = "lm", se = FALSE) +
  ggpubr::stat_cor(label.x.npc = "left", label.y.npc = "top") +
  facet_wrap(~ ring_range_text) +
  scale_color_manual(values = arms_colors, breaks = c("azithro", "placebo")) +
  scale_x_continuous(limits = c(0, 30)) +
  scale_y_continuous(limits = c(0, 50)) +
  labs(x = "Azithromycin doses in the ring (in thousands)", 
       y = "Total doses in the 0 - 10 km ring (in thousands)") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom")

```

Looking at the range of the number of azithromycin doses in the 0 - 10 km ring vs the range of the total number of doses in the 0 - 10 km ring to assess if the counterfactual of what if all the doses in the inner most ring were azithromycin doses is reasonable.

Black lines:

-   Vertical line at the maximum number of total doses in the 0 - 10 km ring

-   Horizontal line at the maximum number of azithromycin doses in the 0 - 10 km ring

There are 12 villages (7 azithro, 5 placebo) where the total doses in the 0 - 10 km ring is greater than the maximum azithromycin doses in the model (Counterfactual won't have enough overlap)

```{r azithro vs total doses in 0 - 10 km ring}

morb_desc_inner <- morb_desc %>%
  dplyr::filter(ring_range_text == "0 - 10 km") %>%
  dplyr::select(grappe, arm, azithro_doses, total_doses, inner_total_doses)

max_az_doses <- max(morb_desc_inner$azithro_doses, na.rm = TRUE)
max_total_doses <- max(morb_desc_inner$inner_total_doses, na.rm = TRUE)

morb_desc_inner <- morb_desc_inner %>%
  mutate(max_az_doses = max_az_doses,
         max_total_doses = max_total_doses,
         over_max_az_doses = total_doses > max_az_doses)
```

Number of grappes with total doses in the 0 - 10 km ring greater than maximum azithromycin doses in the model:
FALSE: where we CAN estimate the counterfactual

```{r}

table(morb_desc_inner$over_max_az_doses, morb_desc_inner$arm)

ggplot(morb_desc_inner, 
       aes(x = azithro_doses, 
           y = inner_total_doses, color = arm)) +
  geom_point() +
  geom_rug(sides = "bl") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "darkgrey") +
  geom_vline(xintercept = max_total_doses) +
  geom_hline(yintercept = max_az_doses) +
  scale_color_manual(values = arms_colors, breaks = c("azithro", "placebo")) +
  scale_x_continuous(limits = c(0, 22)) +
  scale_y_continuous(limits = c(0, 22)) +
  labs(x = "Azithro doses 0 - 10 km ring (in 1000s)", 
       y = "Total doses 0 - 10 km ring (in 1000s)") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom") +
  coord_fixed(ratio = 1)

```

## Proportion of azithromycin doses in each ring

```{r ring dose proportion descriptives}

morb_desc %>%
  dplyr::select(grappe, arm, ring_range_text, proportion_az) %>%
  group_by(arm, ring_range_text) %>%
  summarise(
    min = min(proportion_az, na.rm = TRUE),
    median = median(proportion_az, na.rm = TRUE),
    mean = mean(proportion_az, na.rm = TRUE),
    max = max(proportion_az, na.rm = TRUE),
    iqr = IQR(proportion_az, na.rm = TRUE),
    sd = sd(proportion_az, na.rm = TRUE),
    n = n()
  ) %>%
  mutate(across(where(is.numeric), \(x) round(x, 2))) %>%
  knitr::kable()

ggplot(morb_desc, aes(y = proportion_az, x = arm, color = arm)) +
  geom_boxplot() +
  geom_rug(sides = "l") +
  scale_color_manual(values = arms_colors, breaks = c("azithro", "placebo")) +
  scale_y_continuous(limits = c(0, 1)) +
  facet_wrap(~ ring_range_text) +
  labs(y = "Proportion of azithromycin doses") +
  theme_minimal(base_size = 14) +
  guides(x = "none") +
  theme(axis.title.x = element_blank())

ggplot(morb_desc, aes(y = proportion_az, x = ring_range_text, color = arm, group = grappe)) +
  geom_point() +
  geom_line(alpha = 0.6) +
  scale_color_manual(values = arms_colors, breaks = c("azithro", "placebo")) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(y = "Proportion of azithromycin doses") +
  theme_minimal(base_size = 14)

```

# Log-linear models

## Final models

### Model fitting

Using log-linear models to assess the relationship between azithromycin doses within 10 km, 10-20 km, and 20-30 km of each morbidity trial grappe and the average resistance of MLS antibiotics at 24 months. The models are specified as follows:

-   `Log(AMR) ~ az 0-10 + az 10-20 + az 20-30`: where `az 0-10`, `az 10-20`, and `az 20-30` are the azithromycin doses within 0-10 km, 10-20 km, and 20-30 km of each morbidity trial grappe. Doses are in thousands.
-   `Log(AMR) ~ az 0-10 + az 10-20 + az 20-30 + tot 0-10`: where `tot 0-10` is the total number of doses within 0-10 km of each morbidity trial grappe. Doses are in thousands.

***I am representing the sum of all ring terms (`az 0-10 + az 10-20 + az 20-30`) as az_rings.***

```{r final ring log-linear models}

morb_rings <- morb_rings_raw %>%
  st_drop_geometry() %>%
  dplyr::select(grappe, arm, ring_range_text, azithro_doses) %>%
  mutate(azithro_doses = azithro_doses/ring_div_fct) %>%
  dplyr::filter(ring_range_text %in% c("0 - 10 km", "10 - 20 km", "20 - 30 km")) %>%
  pivot_wider(
    names_from = ring_range_text,
    values_from = azithro_doses
  ) %>%
  rename(
    az_0_10 = `0 - 10 km`,
    az_10_20 = `10 - 20 km`,
    az_20_30 = `20 - 30 km`
  ) %>%
  left_join(amr_dat, by = "grappe") %>%
  left_join(hrsl_rings, by = "grappe") %>%
  left_join(csi_dist, by = "grappe") 

bl_amr <- morb_rings %>%
  dplyr::filter(phase == "Baseline") %>%
  dplyr::select(grappe, avg_res) %>%
  rename(bl_res = avg_res)

morb_rings <- morb_rings %>%
  dplyr::filter(phase == "24 months") %>%
  left_join(bl_amr, by = "grappe")

ring_model_results <- morb_rings %>%
  group_by(arm) %>%
  nest() %>%
  mutate(
    model_log_az = map(data, ~ lm(log(avg_res) ~ az_0_10 + az_10_20 + az_20_30, data = .x)),
    model_log_az_bl = map(data, ~ lm(log(avg_res) ~ az_0_10 + az_10_20 + az_20_30 + bl_res, data = .x)),
    model_log_az_pop = map(data, ~ lm(log(avg_res) ~ az_0_10 + az_10_20 + az_20_30 + u5_pop_scale, data = .x)),
    model_log_az_pop_bl = map(data, ~ lm(log(avg_res) ~ az_0_10 + az_10_20 + az_20_30 + u5_pop_scale + bl_res, data = .x)),
    
    tidy_log_az = map(model_log_az, ~ tidy(.x, conf.int = TRUE) %>% 
                               mutate(exp_est = exp(estimate),
                                      exp_ci_ll = exp(conf.low),
                                      exp_ci_ul = exp(conf.high))),
    tidy_log_az_bl = map(model_log_az_bl, ~ tidy(.x, conf.int = TRUE) %>%
                               mutate(exp_est = exp(estimate),
                                      exp_ci_ll = exp(conf.low),
                                      exp_ci_ul = exp(conf.high))),
    tidy_log_az_pop = map(model_log_az_pop, ~ tidy(.x, conf.int = TRUE) %>%
                            mutate(exp_est = exp(estimate),
                                   exp_ci_ll = exp(conf.low),
                                   exp_ci_ul = exp(conf.high))),
    tidy_log_az_pop_bl = map(model_log_az_pop_bl, ~ tidy(.x, conf.int = TRUE) %>%
                            mutate(exp_est = exp(estimate),
                                   exp_ci_ll = exp(conf.low),
                                   exp_ci_ul = exp(conf.high))),

    glance_log_az = map(model_log_az, glance),
    glance_log_az_bl = map(model_log_az_bl, glance),
    glance_log_az_pop = map(model_log_az_pop, glance),
    glance_log_az_pop_bl = map(model_log_az_pop_bl, glance)
  )

ring_results_table <- ring_model_results %>%
  dplyr::select(arm, starts_with("tidy_"), starts_with("glance_")) %>%
  pivot_longer(cols = starts_with("tidy_"), names_to = "model_type", values_to = "tidy_data") %>%
  unnest(tidy_data) %>%
  dplyr::filter(term %in% c("az_0_10", "az_10_20", "az_20_30", "bl_res", "u5_pop_scale")) %>%
  mutate(
    model_label = factor(case_when(
      model_type == "tidy_log_az" ~ "Log(AMR) ~ az rings",
      model_type == "tidy_log_az_bl" ~ "Log(AMR) ~ az rings + bl res",
      model_type == "tidy_log_az_pop" ~ "Log(AMR) ~ az rings + scaled u5 pop",
      model_type == "tidy_log_az_pop_bl" ~ "Log(AMR) ~ az rings + scaled u5 pop + bl res"
    ), ordered = TRUE, levels = c(
      "Log(AMR) ~ az rings",
      "Log(AMR) ~ az rings + bl res",
      "Log(AMR) ~ az rings + scaled u5 pop",
      "Log(AMR) ~ az rings + scaled u5 pop + bl res"
    ))
  ) %>%
  left_join(
    ring_model_results %>%
      dplyr::select(arm, starts_with("glance_")) %>%
      pivot_longer(cols = starts_with("glance_"), names_to = "model_type", values_to = "glance_data") %>%
      mutate(model_type = str_replace(model_type, "glance_", "tidy_")) %>%
      unnest(glance_data) %>%
      dplyr::select(arm, model_type, r.squared),
    by = c("arm", "model_type")
  ) %>%
  dplyr::select(arm, model_label, term, estimate, conf.low, conf.high,
         exp_est, exp_ci_ll, exp_ci_ul, p.value, r.squared) %>%
  mutate(across(where(is.numeric), \(x) round(x, 2)))

```

### Only azithromycin doses within 10 km

Looking only at the coefficients of doses within 10 km, from all models, at the 24 month timepoint, for each arm:

```{r final az ring doses results}

ring_results_kable <- ring_results_table %>%
  dplyr::filter(term == "az_0_10") %>%
  dplyr::select(arm, model_label, term, estimate,
         exp_est, exp_ci_ll, exp_ci_ul, p.value) %>%
  kable()

save_kable(ring_results_kable, 
            here("figs", "final", "log-linear-model-results.png"), zoom = 2)

ggplot(subset(ring_results_table, term == "az_0_10"), aes(x = exp_est, y = arm, color = arm)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "black") +
  geom_point() +
  geom_errorbarh(aes(xmin = exp_ci_ll, xmax = exp_ci_ul), height = 0.2) +
  facet_wrap(~model_label) +
  scale_color_manual(values = arms_colors) +
  labs(x = paste0("Exponentiated coefficient of az doses (x ", ring_div_fct,") within 10 km"), y = "Arm") +
  guides(y = "none") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom")

ggsave(here("figs", "24-months", "az-ring-model-results.png"),
       width = 8, height = 6, dpi = 600, bg = "white")

```

#### Full results table

```{r}

ring_results_table %>%
  dplyr::select(arm, phase, model_label, term, estimate,
         exp_est, exp_ci_ll, exp_ci_ul, p.value, r.squared) %>%
  knitr::kable()

```

# No chunks evaluated here on

## All old models

## In rings: Without total doses
### Model fitting

Using log-linear models to assess the relationship between azithromycin doses within 10 km, 10-20 km, and 20-30 km of each morbidity trial grappe and the average resistance of MLS antibiotics at 24 months. The models are specified as follows:

-   `Log(AMR) ~ az 0-10 + az 10-20 + az 20-30`: where `az 0-10`, `az 10-20`, and `az 20-30` are the azithromycin doses within 0-10 km, 10-20 km, and 20-30 km of each morbidity trial grappe. Doses are in thousands.

-   `Log(AMR) ~ az 0-10 + az 10-20 + az 20-30 + scaled u5 pop`: where `scaled u5 pop` is the under 5 population estimate (in 1000s) within a 10 km radius of each morbidity trial grappe.

-   `Log(AMR) ~ az 0-10 + az 10-20 + az 20-30 + dist to nearest CSI`: where `dist to nearest CSI` is the distance to the nearest CSI in kilometers.

***I am representing the sum of all ring terms (`az 0-10 + az 10-20 + az 20-30`) as az_rings.***

```{r ring log-linear models, eval=FALSE}

ring_model_results <- morb_rings %>%
  group_by(arm, phase) %>%
  nest() %>%
  mutate(
    model_log_az = map(data, ~ lm(log(avg_res) ~ az_0_10 + az_10_20 + az_20_30, data = .x)),
    model_log_az_pop = map(data, ~ lm(log(avg_res) ~ az_0_10 + az_10_20 + az_20_30 + u5_pop_scale, data = .x)),
    model_log_az_csi = map(data, ~ lm(log(avg_res) ~ az_0_10 + az_10_20 + az_20_30 + dist_csi, data = .x)),
    
    tidy_log_az = map(model_log_az, ~ tidy(.x, conf.int = TRUE) %>% 
                               mutate(exp_est = exp(estimate),
                                      exp_ci_ll = exp(conf.low),
                                      exp_ci_ul = exp(conf.high))),
    tidy_log_az_pop = map(model_log_az_pop, ~ tidy(.x, conf.int = TRUE) %>%
                               mutate(exp_est = exp(estimate),
                                      exp_ci_ll = exp(conf.low),
                                      exp_ci_ul = exp(conf.high))),
    tidy_log_az_csi = map(model_log_az_csi, ~ tidy(.x, conf.int = TRUE) %>% 
                        mutate(exp_est = exp(estimate),
                               exp_ci_ll = exp(conf.low),
                               exp_ci_ul = exp(conf.high))),
    
    glance_log_az = map(model_log_az, glance),
    glance_log_az_pop = map(model_log_az_pop, glance),
    glance_log_az_csi = map(model_log_az_csi, glance)
  )

ring_results_table <- ring_model_results %>%
  dplyr::select(arm, phase, starts_with("tidy_"), starts_with("glance_")) %>%
  pivot_longer(cols = starts_with("tidy_"), names_to = "model_type", values_to = "tidy_data") %>%
  unnest(tidy_data) %>%
  dplyr::filter(term %in% c("az_0_10", "az_10_20", "az_20_30", "u5_pop_scale", "dist_csi")) %>%
  mutate(
    model_label = factor(case_when(
      model_type == "tidy_log_az" ~ "Log(AMR) ~ az rings",
      model_type == "tidy_log_az_pop" ~ "Log(AMR) ~ az rings + scaled u5 pop",
      model_type == "tidy_log_az_csi" ~ "Log(AMR) ~ az rings + dist to CSI"
    ), ordered = TRUE, levels = c(
      "Log(AMR) ~ az rings",
      "Log(AMR) ~ az rings + scaled u5 pop",
      "Log(AMR) ~ az rings + dist to CSI"
    ))
  ) %>%
  left_join(
    ring_model_results %>%
      dplyr::select(arm, phase, starts_with("glance_")) %>%
      pivot_longer(cols = starts_with("glance_"), names_to = "model_type", values_to = "glance_data") %>%
      mutate(model_type = str_replace(model_type, "glance_", "tidy_")) %>%
      unnest(glance_data) %>%
      dplyr::select(arm, phase, model_type, r.squared),
    by = c("arm", "phase", "model_type")
  ) %>%
  dplyr::select(arm, phase, model_label, term, estimate, conf.low, conf.high,
         exp_est, exp_ci_ll, exp_ci_ul, p.value, r.squared) %>%
  mutate(across(where(is.numeric), \(x) round(x, 2)))
```

### Full Results

```{r ring model results, eval=FALSE}
ring_results_table %>%
  dplyr::select(arm, phase, model_label, term, estimate,
         exp_est, exp_ci_ll, exp_ci_ul, p.value, r.squared)
  
```

### Only azithromycin doses within 10 km

Looking only at the coefficients of doses within 10 km, from all models, at the 24 month timepoint, for each arm:

```{r az ring doses results, eval=FALSE}

ring_results_table %>%
  dplyr::filter(term == "az_0_10") %>%
  dplyr::filter(phase == "24 months") %>%
  dplyr::select(arm, phase, model_label, term, estimate,
         exp_est, exp_ci_ll, exp_ci_ul, p.value, r.squared)

ggplot(subset(ring_results_table, term == "az_0_10"), aes(x = exp_est, y = arm, color = arm)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "black") +
  geom_point() +
  geom_errorbarh(aes(xmin = exp_ci_ll, xmax = exp_ci_ul), height = 0.2) +
  facet_wrap(~ model_label + phase, ncol = 2) +
  scale_color_manual(values = arms_colors) +
  labs(x = "Exponentiated coefficient of az doses (in 5 thousands) within 10 km", y = "Arm") +
  guides(y = "none") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom")

ggsave(here("figs", "24-months", "az-ring-model-results.png"),
       width = 8, height = 6, dpi = 600, bg = "white")

```

## Treatment intensity

### Models

Using log-linear models to assess the relationship between azithromycin treatment and the average resistance of MLS antibiotics at 24 months. The models are specified as follows:

-   `Log(AMR) ~ az_int`: where `az_int` is the geographic treatment intensity of azithromycin doses.

-   `Log(AMR) ~ az_int + nce`: where `nce` is the geographic treatment intensity of placebo doses.

-   `Log(AMR) ~ az_int + scaled u5 pop`: where `scaled u5 pop` is the under 5 population estimate (in 1000s) within a 10 km radius of each morbidity trial grappe.

-   `Log(AMR) ~ az_int + dist to nearest CSI`: where `dist to nearest CSI` is the distance to the nearest CSI in kilometers.

```{r Log-linear models of tx int, eval=FALSE}

model_results <- morb_tx %>%
  group_by(arm, phase) %>%
  nest() %>%
  mutate(
    model_log_az = map(data, ~ lm(log(avg_res) ~ azithro_int, data = .x)),
    model_log_az_nce = map(data, ~ lm(log(avg_res) ~ azithro_int + placebo_int, data = .x)),
    model_log_az_pop = map(data, ~ lm(log(avg_res) ~ azithro_int + u5_pop_scale, data = .x)),
    model_log_az_csi = map(data, ~ lm(log(avg_res) ~ azithro_int + dist_csi, data = .x)),
    
    # Tidy output
    tidy_log_az = map(model_log_az, ~ tidy(.x, conf.int = TRUE) %>% 
                        mutate(exp_est = exp(estimate),
                               exp_ci_ll = exp(conf.low),
                               exp_ci_ul = exp(conf.high))),
    
    tidy_log_az_nce = map(model_log_az_nce, ~ tidy(.x, conf.int = TRUE) %>% 
                            mutate(exp_est = exp(estimate),
                                   exp_ci_ll = exp(conf.low),
                                   exp_ci_ul = exp(conf.high))),
    
    tidy_log_az_pop = map(model_log_az_pop, ~ tidy(.x, conf.int = TRUE) %>% 
                            mutate(exp_est = exp(estimate),
                                   exp_ci_ll = exp(conf.low),
                                   exp_ci_ul = exp(conf.high))),
    
    tidy_log_az_csi = map(model_log_az_csi, ~ tidy(.x, conf.int = TRUE) %>%
                            mutate(exp_est = exp(estimate),
                                   exp_ci_ll = exp(conf.low),
                                   exp_ci_ul = exp(conf.high))),
    
    # Model fit
    glance_log_az = map(model_log_az, glance),
    glance_log_az_nce = map(model_log_az_nce, glance),
    glance_log_az_pop = map(model_log_az_pop, glance),
    glance_log_az_csi = map(model_log_az_csi, glance)
  )

results_table <- model_results %>%
  dplyr::select(arm, phase, starts_with("tidy_"), starts_with("glance_")) %>%
  pivot_longer(cols = starts_with("tidy_"), names_to = "model_type", values_to = "tidy_data") %>%
  unnest(tidy_data) %>%
  dplyr::filter(term %in% c("azithro_int", "placebo_int", "u5_pop_scale", "dist_csi")) %>%
  mutate(
    model_label = factor(case_when(
      model_type == "tidy_log_az" ~ "Log(AMR) ~ az_int",
      model_type == "tidy_log_az_nce" ~ "Log(AMR) ~ az_int + nce",
      model_type == "tidy_log_az_pop" ~ "Log(AMR) ~ az_int + scaled u5 pop",
      model_type == "tidy_log_az_csi" ~ "Log(AMR) ~ az_int + dist to nearest CSI"
    ), ordered = TRUE, levels = c(
      "Log(AMR) ~ az_int",
      "Log(AMR) ~ az_int + nce",
      "Log(AMR) ~ az_int + scaled u5 pop",
      "Log(AMR) ~ az_int + dist to nearest CSI"
    ))
  ) %>%
  left_join(
    model_results %>%
      dplyr::select(arm, phase, starts_with("glance_")) %>%
      pivot_longer(cols = starts_with("glance_"), names_to = "model_type", values_to = "glance_data") %>%
      mutate(model_type = str_replace(model_type, "glance_", "tidy_")) %>%
      unnest(glance_data) %>%
      dplyr::select(arm, phase, model_type, r.squared),
    by = c("arm", "phase", "model_type")
  ) %>%
  dplyr::select(arm, phase, model_label, term, estimate, conf.low, conf.high,
         exp_est, exp_ci_ll, exp_ci_ul, p.value, r.squared) %>%
  mutate(across(where(is.numeric), \(x) round(x, 2)))
```

### Full Results

```{r model results, eval=FALSE}

results_table %>%
  dplyr::select(arm, phase, model_label, term, estimate,
         exp_est, exp_ci_ll, exp_ci_ul, p.value, r.squared)

```

### Only azithromycin treatment intensity terms

Looking only at the coefficients of the azithromycin treatment intensity, from all models, at the 24 month timepoint, for each arm:

```{r az tx int results, eval=FALSE}

results_table %>%
  dplyr::filter(term == "azithro_int") %>%
  dplyr::filter(phase == "24 months") %>%
  dplyr::select(arm, phase, model_label, estimate,
         exp_est, exp_ci_ll, exp_ci_ul, p.value, r.squared)

ggplot(subset(results_table, term == "azithro_int"), aes(x = exp_est, y = arm, color = arm)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "black") +
  geom_point() +
  geom_errorbarh(aes(xmin = exp_ci_ll, xmax = exp_ci_ul), height = 0.2) +
  facet_wrap(~ model_label + phase, ncol = 2) +
  scale_color_manual(values = arms_colors) +
  labs(x = "Exponentiated coefficient of az tx int", y = "Arm") +
  guides(y = "none") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom")

ggsave(here("figs", "24-months", "tx-int-model-results.png"),
       width = 8, height = 6, dpi = 600, bg = "white")

```
